<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ—…éŠè¨ˆç•«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #006994; --accent: #FF7F50; --bg: #F4F7F6; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        
        /* é€šç”¨æ¨™é ­ */
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top:0; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; height: 60px;}
        .header-title { font-family: 'Zen Maru Gothic'; font-size: 1.2rem; margin: 0; }
        .back-btn { position: absolute; left: 15px; color: white; text-decoration: none; font-size: 1.5rem; display: none; cursor: pointer;}
        
        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page { display: none; min-height: 100vh; padding-bottom: 100px; }
        .page.active { display: block; }

        /* --- é¦–é ï¼šå°ˆæ¡ˆåˆ—è¡¨æ¨£å¼ --- */
        .trip-container { max-width: 600px; margin: 20px auto; padding: 15px; }
        .trip-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s;
            border-left: 6px solid var(--accent); display: flex; justify-content: space-between; align-items: center;
        }
        .trip-card:active { transform: scale(0.98); }
        .trip-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .trip-url { font-size: 0.8rem; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .btn-remove-trip { color: #ff5252; padding: 10px; font-size: 1.2rem; }

        .add-trip-box {
            background: white; border-radius: 16px; padding: 20px; margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .input-url { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        .btn-add { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }

        /* --- è¡Œç¨‹é ï¼šæ²¿ç”¨ä¹‹å‰çš„æ¨£å¼ (ç°¡åŒ–ç‰ˆ) --- */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .day-section { margin-bottom: 25px; }
        .day-header { background: #E0F7FA; color: var(--primary); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-weight: 700; display: flex; justify-content: space-between; }
        
        .event-card {
            background: white; border-radius: 12px; padding: 12px 10px 12px 16px;
            margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            display: flex; align-items: center; gap: 12px; border-left: 5px solid transparent;
        }
        .type-æ™¯é» { border-left-color: #4FC3F7; } .type-ç¾é£Ÿ { border-left-color: #FF8A65; } .type-äº¤é€š { border-left-color: #90A4AE; } .type-è³¼ç‰© { border-left-color: #BA68C8; } .type-ä½å®¿ { border-left-color: #5C6BC0; }
        
        .drag-handle { color: #ccc; font-size: 20px; cursor: grab; padding: 5px; flex-shrink: 0; }
        .time-box { font-weight: 700; color: var(--primary); font-size: 1.1rem; min-width: 50px; flex-shrink: 0; text-align: center; }
        .info-box { flex: 1; overflow: hidden; cursor: pointer; min-width: 0; }
        .event-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-meta { font-size: 0.85rem; color: #666; display: flex; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-map { width: 40px; height: 40px; border-radius: 50%; background: #E3F2FD; color: #0277BD; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1.2rem; flex-shrink: 0; }

        /* FAB & Modal (æ²¿ç”¨) */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(255, 127, 80, 0.4); cursor: pointer; z-index: 100; display: none; }
        .fab.active { display: flex; }
        
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; text-align: center; padding: 8px; font-size: 0.8rem; transform: translateY(100%); transition: transform 0.3s; z-index: 200; }
        #status-bar.show { transform: translateY(0); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 25px 20px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        label { display: block; margin-bottom: 6px; color: #666; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; min-width: 0; background: #fff; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-submit { background: var(--primary); color: white; }
        .btn-del { background: #ffebee; color: #d32f2f; margin-top: 15px; width: 100%; display: none; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .sortable-ghost { opacity: 0.4; background: #eee; }
    </style>
</head>
<body>

    <header>
        <div class="back-btn" id="btnBack" onclick="goHome()">â€¹</div>
        <h1 class="header-title" id="headerTitle">æˆ‘çš„æ—…éŠè¨ˆç•«</h1>
    </header>

    <!-- é é¢ 1: å°ˆæ¡ˆåˆ—è¡¨ -->
    <div id="page-home" class="page active">
        <div class="trip-container">
            <div id="tripList">
                <!-- JS å‹•æ…‹ç”¢ç”Ÿåˆ—è¡¨ -->
            </div>

            <div class="add-trip-box">
                <h3>ï¼‹ æ–°å¢æ—…éŠè¨ˆç•«</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">è«‹è¼¸å…¥ Google Apps Script ç¶²å€ (Web App URL)</p>
                <input type="text" id="newTripUrl" class="input-url" placeholder="https://script.google.com/macros/s/...">
                <button class="btn-add" onclick="addNewTrip()">åŠ å…¥</button>
            </div>
        </div>
    </div>

    <!-- é é¢ 2: è¡Œç¨‹è©³ç´° -->
    <div id="page-detail" class="page">
        <div id="detailApp" class="container"></div>
    </div>

    <!-- å…±ç”¨å…ƒä»¶ -->
    <div class="fab" id="fabBtn" onclick="openModal('add')">+</div>
    <div id="status-bar">è³‡æ–™å„²å­˜ä¸­...</div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="text-align:center; margin-bottom:20px; margin-top:0;">æ–°å¢è¡Œç¨‹</h2>
            <form id="eventForm">
                <input type="hidden" name="id" id="eventId">
                <div class="form-row">
                    <div class="form-group" style="flex: 3; min-width: 140px;">
                        <label>æ—¥æœŸ</label>
                        <input type="date" name="date" id="inputDate" required>
                    </div>
                    <div class="form-group" style="flex: 2; min-width: 100px;">
                        <label>æ™‚é–“</label>
                        <input type="time" name="time" id="inputTime" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>åç¨±</label>
                    <input type="text" name="title" id="inputTitle" required>
                </div>
                <div class="form-group">
                    <label>åœ°é» (åœ°åœ–æœå°‹ç”¨)</label>
                    <input type="text" name="location" id="inputLocation">
                </div>
                <div class="form-group">
                    <label>é¡å‹</label>
                    <select name="type" id="inputType">
                        <option value="æ™¯é»">æ™¯é»</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <input type="text" name="duration" id="inputDuration">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ç¢ºå®š</button>
                </div>
                <button type="button" class="btn-del" id="btnDel" onclick="handleDelete()">åˆªé™¤</button>
            </form>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let myTrips = JSON.parse(localStorage.getItem('my_trips_list') || '[]');
        let currentTripUrl = '';
        let currentTripData = [];
        let currentTripName = '';

        // --- åˆå§‹åŒ– ---
        renderTripList();

        // --- é é¢åˆ‡æ›é‚è¼¯ ---
        function goHome() {
            document.getElementById('page-home').classList.add('active');
            document.getElementById('page-detail').classList.remove('active');
            document.getElementById('btnBack').style.display = 'none';
            document.getElementById('headerTitle').innerText = 'æˆ‘çš„æ—…éŠè¨ˆç•«';
            document.getElementById('fabBtn').classList.remove('active');
            currentTripUrl = '';
        }

        async function openTrip(url) {
            currentTripUrl = url;
            // UI åˆ‡æ›
            document.getElementById('page-home').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
            document.getElementById('btnBack').style.display = 'block';
            document.getElementById('fabBtn').classList.add('active');
            
            document.getElementById('detailApp').innerHTML = '<div style="text-align:center; padding:50px; color:#999;">è¼‰å…¥è¡Œç¨‹ä¸­...</div>';
            
            // è¼‰å…¥è³‡æ–™
            await loadTripData(url);
        }

        // --- é¦–é åŠŸèƒ½ ---
        function renderTripList() {
            const listEl = document.getElementById('tripList');
            listEl.innerHTML = '';
            
            if (myTrips.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">é‚„æ²’æœ‰æ—…éŠè¨ˆç•«ï¼Œæ–°å¢ä¸€å€‹å§ï¼</div>';
                return;
            }

            myTrips.forEach((trip, index) => {
                const div = document.createElement('div');
                div.className = 'trip-card';
                div.innerHTML = `
                    <div onclick="openTrip('${trip.url}')" style="flex:1">
                        <div class="trip-name">${trip.name || 'è¼‰å…¥ä¸­...'}</div>
                        <div class="trip-url">${trip.url}</div>
                    </div>
                    <div class="btn-remove-trip" onclick="removeTrip(${index})">Ã—</div>
                `;
                listEl.appendChild(div);
            });
        }

        async function addNewTrip() {
            const urlInput = document.getElementById('newTripUrl');
            const url = urlInput.value.trim();
            if (!url) return alert('è«‹è¼¸å…¥ç¶²å€');
            
            // ç°¡å–®é©—è­‰
            if (!url.includes('script.google.com')) return alert('é€™çœ‹èµ·ä¾†ä¸åƒ Google Apps Script ç¶²å€');

            // å…ˆå˜—è©¦æŠ“å–æ¨™é¡Œ
            const btn = document.querySelector('.btn-add');
            btn.innerText = 'é©—è­‰ä¸­...';
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const name = data.title || 'æœªå‘½åæ—…éŠ';
                
                myTrips.push({ name: name, url: url });
                localStorage.setItem('my_trips_list', JSON.stringify(myTrips));
                
                urlInput.value = '';
                renderTripList();
                alert('æ–°å¢æˆåŠŸï¼');
            } catch (e) {
                alert('ç„¡æ³•é€£çµè©²ç¶²å€ï¼Œè«‹ç¢ºèªæ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€\n' + e);
            } finally {
                btn.innerText = 'åŠ å…¥';
            }
        }

        function removeTrip(index) {
            if (confirm('ç¢ºå®šç§»é™¤é€™å€‹é€£çµå—ï¼Ÿ(ä¸æœƒåˆªé™¤ Google Sheet è³‡æ–™)')) {
                myTrips.splice(index, 1);
                localStorage.setItem('my_trips_list', JSON.stringify(myTrips));
                renderTripList();
            }
        }

        // --- è©³ç´°é åŠŸèƒ½ (æ ¸å¿ƒé‚è¼¯) ---
        async function loadTripData(url) {
            // å˜—è©¦è®€å–å€‹åˆ¥å¿«å–
            const cacheKey = 'trip_cache_' + url;
            const cached = localStorage.getItem(cacheKey);
            
            if (cached) {
                const data = JSON.parse(cached);
                currentTripName = data.title;
                currentTripData = data.data;
                renderDetail();
                document.getElementById('headerTitle').innerText = currentTripName;
            }

            // èƒŒæ™¯æ›´æ–°
            showStatus('åŒæ­¥ä¸­...', false);
            try {
                const res = await fetch(url + '?t=' + Date.now(), { redirect: 'follow' });
                const json = await res.json();
                
                // æ›´æ–°å¾Œç«¯å›å‚³çš„æ¨™é¡Œ
                if (json.title) {
                    currentTripName = json.title;
                    document.getElementById('headerTitle').innerText = currentTripName;
                    
                    // æ›´æ–°åˆ—è¡¨è£¡çš„åç¨±
                    const tripIdx = myTrips.findIndex(t => t.url === url);
                    if (tripIdx !== -1) {
                        myTrips[tripIdx].name = json.title;
                        localStorage.setItem('my_trips_list', JSON.stringify(myTrips));
                    }
                }

                currentTripData = json.data || [];
                
                // åˆå§‹åŒ– Order (å¦‚æœæ˜¯èˆŠè³‡æ–™)
                if (currentTripData.length > 0 && !currentTripData[0].order) {
                    currentTripData.sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                    currentTripData.forEach((item, i) => item.order = (i+1)*10000);
                }

                localStorage.setItem(cacheKey, JSON.stringify({ title: currentTripName, data: currentTripData }));
                renderDetail();
                showStatus('åŒæ­¥å®Œæˆ', true);
            } catch (e) {
                showStatus('é›¢ç·šæ¨¡å¼', true);
            }
        }

        function renderDetail() {
            const app = document.getElementById('detailApp');
            app.innerHTML = '';

            // Sort by Order
            currentTripData.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.order || 0) - (b.order || 0);
            });

            const groups = {};
            currentTripData.forEach(item => {
                if (!groups[item.date]) groups[item.date] = [];
                groups[item.date].push(item);
            });

            Object.keys(groups).forEach(date => {
                const dayId = `day-${date}`;
                const dayName = new Date(date).toLocaleDateString('zh-TW', {weekday: 'long'});
                let html = `
                    <div class="day-section">
                        <div class="day-header"><span>ğŸ“… ${date} <small>${dayName}</small></span></div>
                        <div class="event-list" id="${dayId}" data-date="${date}">
                `;
                groups[date].forEach(item => {
                    const query = item.location ? item.location : item.title;
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                    html += `
                        <div class="event-card type-${item.type}" data-id="${item.id}" data-order="${item.order}">
                            <div class="drag-handle">â‰¡</div>
                            <div class="time-box">${item.time}</div>
                            <div class="info-box" onclick="openModal('edit', '${item.id}')">
                                <div class="event-title">${item.title}</div>
                                <div class="event-meta"><span>${item.type}</span>${item.duration?`â€¢ ${item.duration}`:''}</div>
                            </div>
                            <a href="${mapUrl}" target="_blank" class="btn-map">ğŸ—ºï¸</a>
                        </div>`;
                });
                html += `</div></div>`;
                app.innerHTML += html;
            });

            // ç¶å®š Sortable
            document.querySelectorAll('.event-list').forEach(el => {
                new Sortable(el, {
                    handle: '.drag-handle', animation: 150, group: 'shared',
                    onEnd: handleDragEnd
                });
            });
        }

        function handleDragEnd(evt) {
            const item = currentTripData.find(d => d.id === evt.item.getAttribute('data-id'));
            if (!item) return;

            const targetList = evt.to;
            item.date = targetList.getAttribute('data-date'); // æ›´æ–°æ—¥æœŸ
            
            // æ›´æ–° Order
            const siblings = Array.from(targetList.children).filter(el => el !== evt.item);
            const newIndex = evt.newIndex;
            
            let newOrder;
            if (siblings.length === 0) newOrder = 10000;
            else if (newIndex === 0) newOrder = (parseFloat(siblings[0].getAttribute('data-order')) || 0) / 2;
            else if (newIndex >= siblings.length) newOrder = (parseFloat(siblings[siblings.length-1].getAttribute('data-order')) || 0) + 10000;
            else {
                const prev = parseFloat(siblings[newIndex-1].getAttribute('data-order')) || 0;
                const next = parseFloat(siblings[newIndex].getAttribute('data-order')) || 0;
                newOrder = (prev + next) / 2;
            }
            item.order = newOrder;

            // å„²å­˜èˆ‡åŒæ­¥
            const cacheKey = 'trip_cache_' + currentTripUrl;
            localStorage.setItem(cacheKey, JSON.stringify({ title: currentTripName, data: currentTripData }));
            renderDetail();
            backgroundUpdate('edit', { id: item.id, date: item.date, order: newOrder });
        }

        // --- è¡¨å–®èˆ‡æ“ä½œ (æ²¿ç”¨é‚è¼¯) ---
        const form = document.getElementById('eventForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());
            
            if (!rawData.id) { // Add
                rawData.id = 'temp_' + Date.now();
                const maxOrder = currentTripData.reduce((m, p) => p.order > m ? p.order : m, 0);
                rawData.order = maxOrder + 10000;
                currentTripData.push(rawData);
                backgroundUpdate('add', rawData);
            } else { // Edit
                const idx = currentTripData.findIndex(d => d.id === rawData.id);
                if (idx !== -1) {
                    rawData.order = currentTripData[idx].order; // Keep order
                    currentTripData[idx] = { ...currentTripData[idx], ...rawData };
                    backgroundUpdate('edit', rawData);
                }
            }
            const cacheKey = 'trip_cache_' + currentTripUrl;
            localStorage.setItem(cacheKey, JSON.stringify({ title: currentTripName, data: currentTripData }));
            renderDetail();
            closeModal();
        });

        function handleDelete() {
            const id = document.getElementById('eventId').value;
            if (confirm('ç¢ºå®šåˆªé™¤?')) {
                currentTripData = currentTripData.filter(d => d.id !== id);
                const cacheKey = 'trip_cache_' + currentTripUrl;
                localStorage.setItem(cacheKey, JSON.stringify({ title: currentTripName, data: currentTripData }));
                renderDetail();
                closeModal();
                backgroundUpdate('delete', { id: id });
            }
        }

        function backgroundUpdate(action, data) {
            if (!currentTripUrl) return;
            fetch(currentTripUrl, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action, ...data })
            }).catch(e => console.error(e));
        }

        // UI Helpers
        function showStatus(msg, autoHide) {
            const bar = document.getElementById('status-bar');
            bar.innerText = msg; bar.classList.add('show');
            if (autoHide) setTimeout(() => bar.classList.remove('show'), 2000);
        }
        function openModal(mode, id) {
            const modal = document.getElementById('modal');
            const btnDel = document.getElementById('btnDel');
            modal.classList.add('active');
            if (mode === 'edit') {
                document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è¡Œç¨‹';
                btnDel.style.display = 'block';
                const item = currentTripData.find(d => d.id === id);
                // Fill form...
                document.getElementById('eventId').value = item.id;
                document.getElementById('inputDate').value = item.date;
                document.getElementById('inputTime').value = item.time;
                document.getElementById('inputTitle').value = item.title;
                document.getElementById('inputLocation').value = item.location || '';
                document.getElementById('inputType').value = item.type;
                document.getElementById('inputDuration').value = item.duration;
            } else {
                document.getElementById('modalTitle').innerText = 'æ–°å¢è¡Œç¨‹';
                btnDel.style.display = 'none';
                form.reset();
                document.getElementById('eventId').value = '';
                // Defaults
                if(currentTripData.length) document.getElementById('inputDate').value = currentTripData[currentTripData.length-1].date;
                else document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
                const now = new Date();
                document.getElementById('inputTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            }
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        document.getElementById('modal').addEventListener('click', e => { if(e.target.id==='modal') closeModal(); });
    </script>
</body>
</html>
