<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²–ç¹©ä¹‹æ—… 2026 (æ¥µé€Ÿæ‹–æ›³ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ SortableJS ç”¨æ–¼æ‹–æ›³ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #006994; --accent: #FF7F50; --bg: #F4F7F6; --text: #333; }
        
        /* åŸºç¤è¨­å®š */
        * { box-sizing: border-box; } /* é—œéµï¼šè®“ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
        
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 120px; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top:0; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-family: 'Zen Maru Gothic'; font-size: 1.4rem; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        .day-section { margin-bottom: 25px; }
        .day-header { 
            background: #E0F7FA; color: var(--primary); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px;
            font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        .event-list { min-height: 20px; }

        .event-card {
            background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;
            border-left: 5px solid transparent; transition: background 0.2s; position: relative;
            touch-action: manipulation;
        }
        
        .type-æ™¯é» { border-left-color: #4FC3F7; }
        .type-ç¾é£Ÿ { border-left-color: #FF8A65; }
        .type-äº¤é€š { border-left-color: #90A4AE; }
        .type-è³¼ç‰© { border-left-color: #BA68C8; }
        .type-ä½å®¿ { border-left-color: #5C6BC0; }

        .drag-handle { color: #ccc; font-size: 20px; cursor: grab; padding: 5px; }
        .time-box { font-weight: 700; color: var(--primary); font-size: 1.1rem; min-width: 55px; }
        .info-box { flex: 1; overflow: hidden; } /* é˜²æ­¢å…§å®¹æ’é–‹ */
        .event-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-meta { font-size: 0.85rem; color: #666; display: flex; gap: 8px; }
        
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--accent); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.4); cursor: pointer; z-index: 100;
        }

        #status-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white;
            text-align: center; padding: 8px; font-size: 0.8rem; transform: translateY(100%); transition: transform 0.3s; z-index: 200;
        }
        #status-bar.show { transform: translateY(0); }

        /* Modal ä¿®æ­£ç‰ˆ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        
        .modal-content { 
            background: white; 
            width: 85%; /* æ”¹æˆ 85% ç•™é»é‚Šè· */
            max-width: 380px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            padding: 20px; /* ç¨å¾®ç¸®å°å…§è· */
            border-radius: 16px; 
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå¾€å¤–æ’ */
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ä¿®æ­£ */
        input, select { 
            width: 100%; 
            padding: 10px; /* èª¿æ•´èˆ’é©åº¦ */
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; /* 16px é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
            box-sizing: border-box; /* é—œéµ */
        }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-submit { background: var(--primary); color: white; }
        .btn-del { background: #ffebee; color: #d32f2f; margin-top: 10px; width: 100%; display: none; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        
        .sortable-ghost { opacity: 0.4; background: #eee; }
    </style>
</head>
<body>

    <header>
        <h1>Okinawa 2026</h1>
    </header>

    <div id="app" class="container">
        <div style="text-align:center; padding:50px; color:#999;">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="fab" onclick="openModal('add')">+</div>
    <div id="status-bar">è³‡æ–™å„²å­˜ä¸­...</div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="text-align:center; margin-bottom:20px; margin-top:0;">æ–°å¢è¡Œç¨‹</h2>
            <form id="eventForm">
                <input type="hidden" name="id" id="eventId">
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" name="date" id="inputDate" required>
                </div>
                <div class="form-group">
                    <label>æ™‚é–“</label>
                    <input type="time" name="time" id="inputTime" required>
                </div>
                <div class="form-group">
                    <label>åç¨±</label>
                    <input type="text" name="title" id="inputTitle" required placeholder="ä¾‹å¦‚ï¼šåƒæ‹‰éºµ">
                </div>
                <div class="form-group">
                    <label>é¡å‹</label>
                    <select name="type" id="inputType">
                        <option value="æ™¯é»">æ™¯é»</option>
                        <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="ä½å®¿">ä½å®¿</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <input type="text" name="duration" id="inputDuration" placeholder="è¨‚ä½è³‡è¨Šæˆ–åœç•™æ™‚é–“">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ç¢ºå®š</button>
                </div>
                <button type="button" class="btn-del" id="btnDel" onclick="handleDelete()">åˆªé™¤æ­¤è¡Œç¨‹</button>
            </form>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxUMr_-Gxqxzkh1zq1FT8d5_-c1UeCBCqC4AOkdu_vnW-iYMCPzTUtLRDX8TNiDMt2l3g/exec'; 
        let globalData = [];

        init();

        async function init() {
            const cached = localStorage.getItem('tripData');
            if (cached) {
                globalData = JSON.parse(cached);
                render();
            }
            await syncData();
        }

        async function syncData() {
            showStatus('åŒæ­¥è³‡æ–™ä¸­...', false);
            try {
                const res = await fetch(GAS_URL + '?t=' + Date.now(), { redirect: "follow" });
                const data = await res.json();
                globalData = data;
                saveLocal();
                render();
                showStatus('åŒæ­¥å®Œæˆ', true);
            } catch (err) {
                showStatus('é›¢ç·šæ¨¡å¼ / åŒæ­¥å¤±æ•—', true);
            }
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            globalData.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                const toMin = s => { const [h,m] = s.split(':').map(Number); return h*60+m; };
                return toMin(a.time) - toMin(b.time);
            });

            const groups = {};
            globalData.forEach(item => {
                if (!groups[item.date]) groups[item.date] = [];
                groups[item.date].push(item);
            });

            Object.keys(groups).forEach(date => {
                const dayId = `day-${date}`;
                // é¡¯ç¤ºæ˜ŸæœŸå¹¾
                const dayName = new Date(date).toLocaleDateString('zh-TW', {weekday: 'long'});
                
                let html = `
                    <div class="day-section">
                        <div class="day-header">
                            <span>ğŸ“… ${date} <small style="font-size:0.8em; margin-left:5px;">${dayName}</small></span>
                        </div>
                        <div class="event-list" id="${dayId}" data-date="${date}">
                `;
                
                groups[date].forEach(item => {
                    html += `
                        <div class="event-card type-${item.type}" data-id="${item.id}" onclick="openModal('edit', '${item.id}')">
                            <div class="drag-handle">â‰¡</div>
                            <div class="time-box">${item.time}</div>
                            <div class="info-box">
                                <div class="event-title">${item.title}</div>
                                <div class="event-meta">
                                    <span>${item.type}</span>
                                    ${item.duration ? `<span>â€¢ ${item.duration}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                app.innerHTML += html;
            });

            document.querySelectorAll('.event-list').forEach(el => {
                new Sortable(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    group: 'shared',
                    onEnd: function (evt) {
                        handleDragEnd(evt);
                    }
                });
            });
        }

        function handleDragEnd(evt) {
            const itemEl = evt.item;
            const newIndex = evt.newIndex;
            const targetList = evt.to;
            const targetDate = targetList.getAttribute('data-date');
            const itemId = itemEl.getAttribute('data-id');

            const item = globalData.find(d => d.id === itemId);
            if (!item) return;

            item.date = targetDate;

            const prevEl = targetList.children[newIndex - 1];
            const nextEl = targetList.children[newIndex + 1];
            
            let newTime = item.time;
            if (prevEl) {
                newTime = prevEl.querySelector('.time-box').innerText;
            } else if (nextEl) {
                newTime = nextEl.querySelector('.time-box').innerText;
            }
            
            item.time = newTime;
            saveLocal();
            render();
            backgroundUpdate('edit', item);
        }

        const form = document.getElementById('eventForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());
            
            if (!rawData.id) {
                rawData.id = 'temp_' + Date.now();
                globalData.push(rawData);
                backgroundUpdate('add', rawData);
            } else {
                const idx = globalData.findIndex(d => d.id === rawData.id);
                if (idx !== -1) {
                    globalData[idx] = { ...globalData[idx], ...rawData };
                    backgroundUpdate('edit', rawData);
                }
            }
            
            saveLocal();
            render();
            closeModal();
            showStatus('å·²æ›´æ–°', true);
        });

        function handleDelete() {
            const id = document.getElementById('eventId').value;
            if (confirm('ç¢ºå®šåˆªé™¤?')) {
                globalData = globalData.filter(d => d.id !== id);
                saveLocal();
                render();
                closeModal();
                backgroundUpdate('delete', { id: id });
                showStatus('å·²åˆªé™¤', true);
            }
        }

        function backgroundUpdate(action, data) {
            const payload = { action, ...data };
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).catch(err => console.error('Sync failed', err));
        }

        function saveLocal() {
            localStorage.setItem('tripData', JSON.stringify(globalData));
        }

        function showStatus(msg, autoHide) {
            const bar = document.getElementById('status-bar');
            bar.innerText = msg;
            bar.classList.add('show');
            if (autoHide) setTimeout(() => bar.classList.remove('show'), 2000);
        }

        function openModal(mode, id) {
            const modal = document.getElementById('modal');
            const btnDel = document.getElementById('btnDel');
            modal.classList.add('active');
            
            if (mode === 'edit') {
                document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è¡Œç¨‹';
                btnDel.style.display = 'block';
                const item = globalData.find(d => d.id === id);
                document.getElementById('eventId').value = item.id;
                document.getElementById('inputDate').value = item.date;
                document.getElementById('inputTime').value = item.time; // ç·¨è¼¯ï¼šä¿ç•™åŸæ™‚é–“
                document.getElementById('inputTitle').value = item.title;
                document.getElementById('inputType').value = item.type;
                document.getElementById('inputDuration').value = item.duration;
            } else {
                document.getElementById('modalTitle').innerText = 'æ–°å¢è¡Œç¨‹';
                btnDel.style.display = 'none';
                form.reset();
                document.getElementById('eventId').value = '';
                
                // --- æ—¥æœŸé è¨­ ---
                // é è¨­ç‚ºæœ€å¾Œä¸€å€‹è¡Œç¨‹çš„æ—¥æœŸï¼Œå¦‚æœæ²’æœ‰å‰‡é è¨­ä»Šå¤©
                if(globalData.length > 0) {
                     // ç‚ºäº†æ–¹ä¾¿é€£çºŒæ–°å¢ï¼Œé€™è£¡é è¨­ç‚ºåˆ—è¡¨æœ€å¾Œä¸€å¤©çš„æ—¥æœŸ
                     // ç•¶ç„¶ä½ ä¹Ÿå¯ä»¥æ”¹æˆ new Date().toISOString().split('T')[0]
                     document.getElementById('inputDate').value = globalData[globalData.length-1].date;
                } else {
                     document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
                }

                // --- æ™‚é–“é è¨­ (æ–°å¢åŠŸèƒ½) ---
                // å–å¾—ç¾åœ¨æ™‚é–“ HH:mm
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('inputTime').value = `${hours}:${minutes}`;
            }
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        document.getElementById('modal').addEventListener('click', (e) => {
             if(e.target.id === 'modal') closeModal();
        });
    </script>
</body>
</html>
